{% extends 'base.html.twig' %}

{% block title %}Mon projet | {{ parent() }}{% endblock %}

{% block javascripts %}
	{{ parent() }}
	{{ encore_entry_script_tags('front/user/project/aides') }}
{% endblock %}

{% block body %}

<div class="fr-container fr-mb-5w fr-mt-0">
    <div class="fr-grid-row">
        {% include "user/_menu_user.html.twig" with { user_project:true, user_project_structure:true } %}
        
        <div class="fr-col-12 fr-col-md-9">
            <div class="fr-grid-row">
                <div class="fr-col-12 fr-col-md-9">
                    <h1 class="fr-h3">Mon projet ¬´ {{ project.name }} ¬ª</h1>
                </div>
                <div class="fr-col-12 fr-col-md-3">
                    <a href="{{ path('app_user_project_structure') }}" class="fr-m-1w fr-tag _fr-tag--md fr-text--md fr-icon-arrow-left-line fr-tag--icon-left">Retour aux projets</a>
                </div>
            </div>
            <div class="fr-tabs fr-mt-0w fr-mb-5w">
                {% include "user/project/_menu_project.html.twig" with { aides: true, project_id: project.id, project_slug: project.slug } %}
                <div id="tabpanel_liste_des_aides" class="fr-tabs__panel" role="tabpanel" aria-labelledby="tabpanel_liste_des_aides" tabindex="0">
                    {# <h2 class="fr-h6 _fr-mt-1w">Liste des aides que vous avez s√©lectionn√©es</h2> #}
                    <div class="fr-table">
                        <table class="data-table at-table--xl">
                            <caption>
                                Liste des aides que vous avez s√©lectionn√©es :
                            </caption>
                            <thead>
                                <tr>
                                    <th scope="col" class="fr-text">Nom</th>
                                    <th scope="col" class="fr-text">Ech√©ance</th>
                                    <th scope="col" class="fr-text">Type d‚Äôaide</th>
                                    <th scope="col" class="fr-text">Porteur d‚Äôaides</th>
                                    <th scope="col" class="fr-text">Ajout√©e le</th>
                                    <th scope="col" class="fr-text">Par</th>
                                    <th scope="col" class="fr-text">Statut</th>
                                    <th scope="col" class="fr-text">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if project.aidProjects|length > 0 %}
                                    {% for aidProject in project.aidProjects %}
                                        <tr id="aidProject-{{ aidProject.id }}"> 
                                            <td class="fr-text">
                                                <a href="{{ path('app_aid_aid_details', {'slug': aidProject.aid.slug}) }}" target="_blank" rel="noopener" id="aid-{{ aidProject.aid.id }}">
                                                    {{ aidProject.aid.name }}
                                                    <span class="fr-sr-only">Ouvre une nouvelle fen√™tre</span>
                                                </a>
                                            </td>
                                            <td class="fr-text">
                                                <span>{{ aidProject.aid.dateSubmissionDeadline|date('d/m/Y') }}</span>
                                                {% if aidProject.aid.isOnGoing() %}
                                                    <p class="fr-badge fr-badge--info fr-badge--sm">Permanente</p>
                                                {% elseif  aidProject.aid.isRecurring() %}
                                                    <p class="fr-badge fr-badge--info fr-badge--sm">R√©currente</p>
                                                {% elseif  aidProject.aid.isApproachingDeadline() %}
                                                    <p class="fr-badge fr-badge--new fr-badge--sm">√âch√©ance proche</p>                       
                                                {% elseif  aidProject.aid.hasExpired() %}
                                                    <p class="fr-badge fr-badge--warning fr-badge--sm">Expir√©e</p>
                                                {% endif %}
                                            </td>
                                            <td class="fr-text">
                                                {% for aidType in aidProject.aid.aidTypes %}
                                                    {{ aidType.name }}
                                                {% endfor %} 
                                            </td>
                                            <td class="fr-text">
                                                <ul>
                                                    {% for financer in aidProject.aid.aidFinancers %}
                                                        <li>
                                                            <a href="{{ path('app_backer_details', {'id': financer.backer.id, 'slug': financer.backer.slug}) }}" target="_blank" rel="noopener">
                                                                {{ financer.backer.name }}
                                                                <span class="fr-sr-only">Ouvre une nouvelle fen√™tre</span>
                                                            </a>
                                                        </li>
                                                    {% endfor %} 
                                                </ul>
                                            </td>      
                                            <td class="fr-text">
                                                {{ aidProject.dateCreate|date('d/m/Y') }}
                                            </td>
                                            <td class="fr-text">
                                                {% if aidProject.creator %}
                                                    {% if aidProject.creator.id == app.user.id %}
                                                        Vous
                                                    {% else %}
                                                        {{ aidProject.creator.firstName }} {{ aidProject.creator.lastName }}
                                                    {% endif %}
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if aidProject.aidPaid %}
                                                <span class="fr-mb-1w fr-badge fr-badge--success">Re√ßue</span>
                                                {% elseif aidProject.aidObtained %}
                                                <span class="fr-mb-1w fr-badge fr-badge--success">Obtenue</span>
                                                {% elseif aidProject.aidDenied %}
                                                <span class="fr-mb-1w fr-badge fr-badge--error">Refus√©e</span>
                                                {% elseif aidProject.aidRequested %}
                                                <span class="fr-mb-1w fr-badge fr-badge--info">Demand√©e</span>
                                                {% endif %}
                                                <button
                                                    class="fr-btn edit-aid-project"
                                                    {# id="aidproject-status-modal-btn" #}
                                                    title="Editer"
                                                    {% if formAidProjectEditHasError == aidProject.id %}
                                                    data-fr-opened="true"
                                                    {% else %}
                                                    data-fr-opened="false"
                                                    {% endif %}
                                                    aria-controls="aidproject-status-modal-{{ aidProject.id }}"
                                                    aria-describedby="aidproject-status-{{ aidProject.id }}"
                                                >
                                                    Editer
                                                </button>
                                            </td>
                                <td class="fr-text">
                                    <button
                                        class="fr-btn fr-icon-delete-line fr-btn--tertiary fr-btn--tertiary-no-outline at-box-shadow--none"
                                        {# id="delete-aid-modal-btn" #}
                                        title="Supprimer cette aide"
                                        data-fr-opened="false"
                                        aria-controls="delete-aid-modal"
                                        aria-describedby="aidProject-{{ aidProject.id }}"
                                        data-id_aid_project = "{{ aidProject.id }}"
                                    >
                                        Supprimer cette aide
                                    </button>
                                </td>
                                        </tr>
                                    {% endfor %}
                                {% else %}
                                    <tbody>
                                        <tr>
                                            <td colspan="8" class="fr-text at-centered-important">
                                                Aucune aide n‚Äôa √©t√© ajout√© √† ce projet pour l‚Äôinstant
                                            </td>
                                        </tr>
                                    </tbody>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>

                    {% if project.id %}
                        <p>
                        <button type="button" class="fr-btn fr-btn--secondary fr-icon-download-line fr-btn--icon-left" id="export-project-btn" data-fr-opened="false" aria-controls="export-project-modal-{{ project.id }}" data-fr-js-modal-button="true" {% if project.aidProjects|length == 0 %}disabled="disabled"{% endif %}>
                            Exporter ce projet
                        </button>
                        </p>
                    {% endif %}

                    <div class="fr-alert fr-alert--info fr-alert--sm fr-mt-5w">
                        <h3 class="fr-h6 _fr-mt-1w">D√©couvrez toutes vos opportunit√©s üåü</h3>
                        {# <p>Si nous avons s√©lectionn√© pour vous des aides sp√©cifiques, n'oubliez pas que d'autres opportunit√©s pourraient vous attendre dans notre base de donn√©es. Chaque projet est unique, et une aide insoup√ßonn√©e pourrait √™tre la cl√© de votre r√©ussite.</p> #}
                        <p>Si vous avez s√©lectionn√© des aides sp√©cifiques, n'oubliez pas que d'autres opportunit√©s pourraient vous attendre dans notre base de donn√©es. Chaque projet est unique, et une aide insoup√ßonn√©e pourrait √™tre la cl√© de votre r√©ussite.</p>
                        <div class="fr-mt-2w fr-mb-2w">
                            {% if project.projectReference %}
                            <a class="fr-btn fr-fi-search-line fr-btn--icon-left" href="{{ path('app_aid_aid', {'keyword': project.projectReference.name}) }}" title="Trouver des aides">Explorer toutes les aides</a>
                            {% else %}
                            <a class="fr-btn fr-fi-search-line fr-btn--icon-left" href="{{ path('app_aid_aid') }}" title="Trouver des aides">Explorer toutes les aides</a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block modal %}
    {# suggestion aides #}
    {% if projectCreated %}
        <dialog aria-labelledby="fr-modal-title-project-search-aid-{{ project.id }}" role="dialog" id="project-search-aid-modal-{{ project.id }}" class="fr-modal fr-modal--opened">
            <div class="fr-container fr-container--fluid fr-container-md">
                <div class="fr-grid-row fr-grid-row--center">
                    <div class="fr-col-12 fr-col-md-8 fr-col-lg-6">
                        <div class="fr-modal__body">
                            <div class="fr-modal__header">
                                <button class="fr-link--close fr-link" title="Fermer la fen√™tre modale" aria-controls="project-search-aid-modal-{{ project.id }}">Fermer</button>
                            </div>
                            <div class="fr-modal__content">
                                <h2 id="fr-modal-title-project-search-aid-{{ project.id }}" class="fr-modal__title"><span class="fr-icon-arrow-right-line fr-icon--lg"></span>Votre projet a bien √©t√© cr√©√©.</h2>
                                {% if aidsSuggested|length > 1 %}
                                <p>Nous avons trouv√© <strong>{{ aidsSuggested|length }} aides</strong> qui pourraient lui correspondre, voulez-vous les consulter ?</p>
                                {% elseif aidsSuggested|length > 0 %}
                                <p>Nous avons trouv√© <strong>{{ aidsSuggested|length }} aide</strong> qui pourrait lui correspondre, voulez-vous la consulter ?</p>
                                {% else %}
                                <p>Nous n‚Äôavons pas trouv√© d‚Äôaide correspondant √† ce projet, mais pas de panique, c‚Äôest peut-√™tre parce que le nom est trop sp√©cifique ou qu‚Äôil n‚Äôy pas encore d‚Äôaide existante.</p>
                                <p><strong>Souhaitez-vous chercher des aides maintenant ?</strong></p>
                                <p><span aria-hidden=‚Äùtrue‚Äù>üí°</span> Pour trouver des aides sp√©cifiques √† votre projet, n‚Äôh√©sitez pas √† √©largir le champ lexical ou √† mettre des synonymes.</p>
                                {% endif %}
                                <footer>
                                    <ul class="fr-btns-group fr-btns-group--inline fr-btns-group--right">
                                        <li>
                                            <button class="btn-block fr-btn fr-btn--secondary" type="button" title="Fermer la fen√™tre modale" aria-controls="project-search-aid-modal-{{ project.id }}">Non merci</button>
                                        </li>
                                        <li>
                                            {% if aidsSuggested|length > 0 %}
                                                <a href="{{ path('app_aid_aid', {'keyword': searchParams.keyword, 'searchPerimeter': searchParams.searchPerimeter, 'organizationType': searchParams.organizationType})  }}" class="fr-btn">
                                            {% else %}
                                                <a href="{{ path('app_aid_aid', {'searchPerimeter': searchParams.searchPerimeter, 'organizationType': searchParams.organizationType})  }}" class="fr-btn">
                                            {% endif %}
                                            OK, j‚Äôy vais!
                                            </a>
                                        </li>
                                    </ul>
                                </footer>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </dialog>
    {% endif %}

    {# delete aid project #}
    <dialog aria-labelledby="fr-modal-title-delete-aid" role="dialog" id="delete-aid-modal" class="fr-modal">
        <div class="fr-container fr-container--fluid fr-container-md">
            <div class="fr-grid-row fr-grid-row--center">
                <div class="fr-col-12 fr-col-md-8 fr-col-lg-6">
                    <div class="fr-modal__body">
                        <div class="fr-modal__header">
                            <button class="fr-btn fr-btn--close" title="Fermer la fen√™tre modale" aria-controls="delete-aid-modal">Fermer</button>
                        </div>
                        <div class="fr-modal__content">
                            <h2 id="fr-modal-title-delete-aid" class="fr-modal__title"><span class="fr-icon-arrow-right-line fr-icon--lg"></span>Supprimer cette aide</h2>

                            <p>En cliquant sur le bouton ci-dessous, vous supprimerez d√©finitivement cette aide de votre projet.</p>
                            {{ form_start(formAidProjectDelete) }}
                                <div class="content">
                                    {{ form_widget(formAidProjectDelete.idAidProject) }}
                                </div>
                                <footer>
                                    <ul class="fr-btns-group fr-btns-group--inline fr-btns-group--right">
                                        <li>
                                            <button class="btn-block fr-btn fr-btn--secondary" type="button" title="Fermer la fen√™tre modale" aria-controls="delete-aid-modal">Annuler</button>
                                        </li>
                                        <li>
                                            <button type="submit" class="fr-btn">
                                                Supprimer cette aide
                                            </button>
                                        </li>
                                    </ul>
                                </footer>
                            {{ form_end(formAidProjectDelete) }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </dialog>

    {# Modifier le statut de l'aide #}
    {% for idAidProject, formAidProjectEdit in formAidProjectEdits %}
    {% set formAidProjectEdit = formAidProjectEdit.createView() %}
    <dialog aria-labelledby="fr-modal-title-aidproject-status" role="dialog" id="aidproject-status-modal-{{ idAidProject }}" class="fr-modal">
        <div class="fr-container fr-container--fluid fr-container-md">
            <div class="fr-grid-row fr-grid-row--center">
                <div class="fr-col-12 fr-col-md-8 fr-col-lg-6">
                    <div class="fr-modal__body">
                        <div class="fr-modal__header">
                            <button class="fr-btn fr-btn--close" title="Fermer la fen√™tre modale" aria-controls="aidproject-status-modal-{{ idAidProject }}">Fermer</button>
                        </div>
                        <div class="fr-modal__content">
                            <h2 id="fr-modal-title-aidproject-status" class="fr-modal__title fr-mt-0"><span class="fr-icon-arrow-right-line fr-icon--lg"></span>Mettre √† jour le statut de cette aide</h2>
                            {{ form_start(formAidProjectEdit, {'attr': {'name': 'aidproject_status'}}) }}
                                <div class="content">
                                    {{ form_row(formAidProjectEdit.aidRequested) }}
                                    {{ form_row(formAidProjectEdit.aidObtained) }}
                                    {{ form_row(formAidProjectEdit.aidPaid) }}
                                    {{ form_row(formAidProjectEdit.aidDenied) }}
                                    <footer>
                                        <button class="btn-block fr-btn fr-mt-2w" type="submit">
                                            Mettre √† jour le statut de cette aide
                                        </button>
                                    </footer>
                                </div>
                            {{ form_end(formAidProjectEdit) }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </dialog>
    {% endfor %}

    {# Exporter le projet #}
    <dialog aria-labelledby="fr-modal-title-export-project" role="dialog" id="export-project-modal-{{ project.id }}" class="fr-modal">
        <div class="fr-container fr-container--fluid fr-container-md">
            <div class="fr-grid-row fr-grid-row--center">
                <div class="fr-col-12 fr-col-md-8 fr-col-lg-6">
                    <div class="fr-modal__body">
                        <div class="fr-modal__header">
                            <button class="fr-btn fr-btn--close" title="Fermer la fen√™tre modale" aria-controls="export-project-modal-{{ project.id }}">Fermer</button>
                        </div>
                        <div class="fr-modal__content">
                            <h1 id="fr-modal-title-export-project" class="fr-modal__title"><span class="fr-icon-arrow-right-line fr-icon--lg"></span>Exporter ce projet</h1>

                            <p>Les champs marqu√©s d‚Äôun ast√©risque (*) sont obligatoires.</p>

                            {{ form_start(formExportProject)}}
                                <div class="content">
                                    {{ form_row(formExportProject.format) }}
                                    <footer>
                                        <button class="btn-block fr-btn fr-mt-2w" type="submit">
                                            Exporter ce projet
                                        </button>
                                    </footer>
                                </div>
                            {{ form_end(formExportProject)}}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </dialog>
{% endblock %}
